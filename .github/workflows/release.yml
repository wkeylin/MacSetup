name: Build and Release

on:
  release:
    types: [created]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªtag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ç”Ÿæˆchangelog
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## What's Changed" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"* %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ steps.version.outputs.version }}" >> CHANGELOG.md
          else
            echo "## What's Changed" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "Initial release of Mac Init - macOS automation tool" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"* %s (%h)" >> CHANGELOG.md
          fi
          
          # è¾“å‡ºchangelogå†…å®¹ç”¨äºåç»­æ­¥éª¤
          {
            echo "changelog<<EOF"
            cat CHANGELOG.md
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create build directory
        run: |
          mkdir -p build
          mkdir -p dist

      - name: Prepare source files (exclude docs)
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p build/mac-init
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶å’Œç›®å½•ï¼Œæ’é™¤docs
          cp init.sh build/mac-init/
          cp README.md build/mac-init/
          cp CLAUDE.md build/mac-init/
          cp -r scripts build/mac-init/
          cp -r configs build/mac-init/
          
          # åˆ›å»ºç©ºçš„logsç›®å½•
          mkdir -p build/mac-init/logs
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "${{ steps.version.outputs.version }}" > build/mac-init/VERSION
          echo "Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build/mac-init/VERSION
          echo "Git commit: ${{ github.sha }}" >> build/mac-init/VERSION

      - name: Create source archive
        run: |
          cd build
          tar -czf ../dist/mac-init-${{ steps.version.outputs.version }}.tar.gz mac-init/
          cd ..
          
          # éªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸ
          ls -la dist/
          echo "Created archive: dist/mac-init-${{ steps.version.outputs.version }}.tar.gz"

      - name: Generate self-extracting installer
        run: |
          # åˆ›å»ºè‡ªè§£å‹å®‰è£…è„šæœ¬
          cat > dist/mac-init-installer-${{ steps.version.outputs.version }}.sh << 'EOF'
          #!/bin/bash
          # Mac Init Self-Extracting Installer
          # Version: ${{ steps.version.outputs.version }}
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          set -euo pipefail
          
          # é¢œè‰²å®šä¹‰
          readonly RED='\033[0;31m'
          readonly GREEN='\033[0;32m'
          readonly YELLOW='\033[1;33m'
          readonly BLUE='\033[0;34m'
          readonly CYAN='\033[0;36m'
          readonly NC='\033[0m'
          
          # é…ç½®
          readonly VERSION="${{ steps.version.outputs.version }}"
          readonly INSTALL_DIR="${MAC_INIT_DIR:-$HOME/mac-init}"
          readonly TEMP_DIR="/tmp/mac-init-installer-$$"
          
          # æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
          show_welcome() {
              echo -e "${CYAN}"
              cat << 'WELCOME_EOF'
             __  __              ___       _ _   
            |  \/  |            |_ _|_ __ (_) |_ 
            | |\/| | __ _  ___   | || '_ \| | __|
            | |  | |/ _` |/ __|  | || | | | | |_ 
            |_|  |_|\__,_|\___| |___|_| |_|_|\__|
                                                
                  Mac ç”µè„‘è‡ªåŠ¨åˆå§‹åŒ–å·¥å…·
          WELCOME_EOF
              echo -e "${NC}"
              echo -e "${BLUE}Mac Init Installer ${VERSION}${NC}"
              echo -e "${BLUE}ä¸€é”®é…ç½®ä½ çš„ Macï¼Œä»å…¨æ–°ç³»ç»Ÿåˆ°å®Œç¾å·¥ä½œç¯å¢ƒ${NC}"
              echo ""
          }
          
          # æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
          check_requirements() {
              echo -e "${CYAN}æ£€æŸ¥ç³»ç»Ÿè¦æ±‚...${NC}"
              
              # æ£€æŸ¥macOS
              if [[ "$OSTYPE" != "darwin"* ]]; then
                  echo -e "${RED}é”™è¯¯: æ­¤å·¥å…·ä»…æ”¯æŒ macOS ç³»ç»Ÿ${NC}" >&2
                  exit 1
              fi
              
              # æ£€æŸ¥macOSç‰ˆæœ¬
              local current_version
              current_version=$(sw_vers -productVersion)
              echo -e "${GREEN}âœ“ macOS ç‰ˆæœ¬: $current_version${NC}"
              
              # æ£€æŸ¥ç£ç›˜ç©ºé—´
              local available_gb
              available_gb=$(df -g / | awk 'NR==2 {print $4}')
              if [[ $available_gb -lt 2 ]]; then
                  echo -e "${YELLOW}è­¦å‘Š: å¯ç”¨ç£ç›˜ç©ºé—´è¾ƒå°‘ (${available_gb}GB)${NC}"
              else
                  echo -e "${GREEN}âœ“ ç£ç›˜ç©ºé—´: ${available_gb}GB å¯ç”¨${NC}"
              fi
          }
          
          # è§£å‹æ–‡ä»¶
          extract_files() {
              echo -e "${CYAN}è§£å‹å®‰è£…æ–‡ä»¶...${NC}"
              
              # åˆ›å»ºä¸´æ—¶ç›®å½•
              mkdir -p "$TEMP_DIR"
              
              # æ‰¾åˆ°å‹ç¼©åŒ…æ•°æ®çš„å¼€å§‹ä½ç½®
              local archive_start
              archive_start=$(awk '/^__ARCHIVE_BELOW__$/{print NR + 1; exit 0; }' "$0")
              
              # è§£å‹æ•°æ®
              tail -n +$archive_start "$0" | base64 -d | tar -xzf - -C "$TEMP_DIR"
              
              echo -e "${GREEN}âœ“ æ–‡ä»¶è§£å‹å®Œæˆ${NC}"
          }
          
          # å®‰è£…æ–‡ä»¶
          install_files() {
              echo -e "${CYAN}å®‰è£…åˆ° $INSTALL_DIR...${NC}"
              
              # å¤‡ä»½ç°æœ‰å®‰è£…
              if [[ -d "$INSTALL_DIR" ]]; then
                  local backup_dir="${INSTALL_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
                  echo -e "${YELLOW}å¤‡ä»½ç°æœ‰å®‰è£…: $backup_dir${NC}"
                  mv "$INSTALL_DIR" "$backup_dir"
              fi
              
              # åˆ›å»ºå®‰è£…ç›®å½•
              mkdir -p "$(dirname "$INSTALL_DIR")"
              
              # ç§»åŠ¨æ–‡ä»¶
              mv "$TEMP_DIR/mac-init" "$INSTALL_DIR"
              
              # è®¾ç½®æ‰§è¡Œæƒé™
              chmod +x "$INSTALL_DIR/init.sh"
              
              echo -e "${GREEN}âœ“ å®‰è£…å®Œæˆ${NC}"
          }
          
          # æ˜¾ç¤ºå®Œæˆä¿¡æ¯
          show_completion() {
              echo ""
              echo -e "${GREEN}ğŸ‰ Mac Init å®‰è£…å®Œæˆï¼${NC}"
              echo ""
              echo -e "${CYAN}å¿«é€Ÿå¼€å§‹:${NC}"
              echo -e "  cd $INSTALL_DIR"
              echo -e "  ./init.sh"
              echo ""
              echo -e "${CYAN}æˆ–è€…ä½¿ç”¨é…ç½®æ–¹æ¡ˆ:${NC}"
              echo -e "  ./init.sh --profile developer"
              echo -e "  ./init.sh --profile designer"
              echo -e "  ./init.sh --profile basic"
              echo ""
              echo -e "${CYAN}æ›´å¤šå¸®åŠ©:${NC}"
              echo -e "  ./init.sh --help"
              echo ""
          }
          
          # æ¸…ç†å‡½æ•°
          cleanup() {
              if [[ -d "$TEMP_DIR" ]]; then
                  rm -rf "$TEMP_DIR"
              fi
          }
          
          # ä¸»å‡½æ•°
          main() {
              # è®¾ç½®æ¸…ç†
              trap cleanup EXIT
              
              show_welcome
              check_requirements
              extract_files
              install_files
              show_completion
              
              # è¯¢é—®æ˜¯å¦ç«‹å³è¿è¡Œ
              echo -n "æ˜¯å¦ç«‹å³å¼€å§‹é…ç½®? [y/N]: "
              read -r response
              if [[ "$response" =~ ^[Yy] ]]; then
                  cd "$INSTALL_DIR"
                  exec ./init.sh
              fi
          }
          
          # æ£€æŸ¥æ˜¯å¦ç›´æ¥æ‰§è¡Œ
          if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
              main "$@"
          fi
          
          exit 0
          __ARCHIVE_BELOW__
          EOF
          
          # å°†å‹ç¼©åŒ…æ•°æ®ä»¥base64ç¼–ç é™„åŠ åˆ°è„šæœ¬æœ«å°¾
          if [[ ! -f "dist/mac-init-${{ steps.version.outputs.version }}.tar.gz" ]]; then
            echo "Error: Source archive not found!"
            exit 1
          fi
          
          base64 -i dist/mac-init-${{ steps.version.outputs.version }}.tar.gz >> dist/mac-init-installer-${{ steps.version.outputs.version }}.sh
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x dist/mac-init-installer-${{ steps.version.outputs.version }}.sh

      - name: Create lite installer (without configs)
        run: |
          # åˆ›å»ºè½»é‡ç‰ˆï¼ˆä»…æ ¸å¿ƒè„šæœ¬ï¼‰
          mkdir -p build/mac-init-lite
          cp init.sh build/mac-init-lite/
          cp -r scripts build/mac-init-lite/
          mkdir -p build/mac-init-lite/configs/packages
          mkdir -p build/mac-init-lite/configs/profiles
          mkdir -p build/mac-init-lite/configs/system
          mkdir -p build/mac-init-lite/logs
          echo "${{ steps.version.outputs.version }}" > build/mac-init-lite/VERSION
          
          cd build
          tar -czf ../dist/mac-init-lite-${{ steps.version.outputs.version }}.tar.gz mac-init-lite/
          cd ..

      - name: Generate checksums
        run: |
          cd dist
          # ä½¿ç”¨macOSåŸç”Ÿçš„shasumå‘½ä»¤
          shasum -a 256 *.tar.gz *.sh > checksums.txt
          shasum -a 512 *.tar.gz *.sh > checksums-sha512.txt
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ ¡éªŒå’Œæ–‡ä»¶
          echo "Generated checksums:"
          cat checksums.txt
          echo ""
          echo "Generated SHA512 checksums:"
          cat checksums-sha512.txt

      - name: Create quick install script
        run: |
          cat > dist/install.sh << 'EOF'
          #!/bin/bash
          # Mac Init Quick Installer
          # Downloads and runs the latest installer
          
          set -euo pipefail
          
          readonly REPO="${{ github.repository }}"
          readonly VERSION="${{ steps.version.outputs.version }}"
          readonly INSTALLER_URL="https://github.com/${REPO}/releases/download/${VERSION}/mac-init-installer-${VERSION}.sh"
          
          echo "Downloading Mac Init ${VERSION}..."
          
          if command -v curl >/dev/null 2>&1; then
              curl -fsSL "$INSTALLER_URL" -o mac-init-installer.sh
          elif command -v wget >/dev/null 2>&1; then
              wget -q "$INSTALLER_URL" -O mac-init-installer.sh
          else
              echo "Error: Neither curl nor wget is available" >&2
              exit 1
          fi
          
          chmod +x mac-init-installer.sh
          ./mac-init-installer.sh "$@"
          EOF
          
          chmod +x dist/install.sh

      - name: Update release with changelog and assets
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            dist/mac-init-${{ steps.version.outputs.version }}.tar.gz
            dist/mac-init-lite-${{ steps.version.outputs.version }}.tar.gz
            dist/mac-init-installer-${{ steps.version.outputs.version }}.sh
            dist/install.sh
            dist/checksums.txt
            dist/checksums-sha512.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate installation statistics
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cd dist
          for file in *.tar.gz *.sh *.txt; do
            if [[ -f "$file" ]]; then
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "- **$file** ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Install Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Method 1: Direct installer download" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://github.com/${{ github.repository }}/releases/latest/download/install.sh | bash" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Method 2: Download and run installer" >> $GITHUB_STEP_SUMMARY
          echo "wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/mac-init-installer-${{ steps.version.outputs.version }}.sh" >> $GITHUB_STEP_SUMMARY
          echo "chmod +x mac-init-installer-${{ steps.version.outputs.version }}.sh" >> $GITHUB_STEP_SUMMARY
          echo "./mac-init-installer-${{ steps.version.outputs.version }}.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY